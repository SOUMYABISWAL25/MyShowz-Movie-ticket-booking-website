<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ticket Booking</title>
  <link rel="stylesheet" type="text/css" href="assets/css/style-starter.css">
  <link rel="stylesheet" href="https://npmcdn.com/flickity@2/dist/flickity.css">
  <link rel="stylesheet" type="text/css" href="assets/css/progress.css">

  <link rel="stylesheet" type="text/css" href="assets/css/ticket-booking.css">

  <!-- ..............For progress-bar............... -->
  <link rel="stylesheet" type="text/css" href="assets/css/e-ticket.css">

  <link rel="stylesheet" type="text/css" href="assets/css/payment.css" />
  <link href="https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz:400,700" rel="stylesheet">
</head>

<body>
  <header id="site-header" class="w3l-header fixed-top">

    <!--/nav-->
    <nav class="navbar navbar-expand-lg navbar-light fill px-lg-0 py-0 px-3">
      <div class="container">
        <h1><a class="navbar-brand" href="index.html"><span class="fa fa-play icon-log" aria-hidden="true"></span>
            MyShowz </a></h1>
        
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
        </div>

        <!-- toggle switch for light and dark theme -->
        <div class="mobile-position">
          <nav class="navigation">
            <div class="theme-switch-wrapper">
              <label class="theme-switch" for="checkbox">
                <input type="checkbox" id="checkbox">
                <div class="mode-container">
                  <i class="gg-sun"></i>
                  <i class="gg-moon"></i>
                </div>
              </label>
            </div>
          </nav>
        </div>
      </div>
    </nav>
  </header>

  <div class="container" id="progress-container-id">
    <div class="row">
      <div class="col">
        <div class="px-0 pt-4 pb-0 mt-3 mb-3">
          <form id="form">
            <ul id="progressbar" class="progressbar-class">
              <li class="active" id="step1">Show timing selection</li>
              <li id="step2" class="not_active">Seat Selection</li>
              <li id="step3" class="not_active">Payment</li>
              <li id="step4" class="not_active">E-Ticket</li>
            </ul>
            <br>
            <fieldset>
              <div id="screen-select-div">
                <h2>Show time Selection</h2>
                <div class="current-datetime">
                  <span id="current-date-display"></span>
                  <span id="current-time-display"></span>
                </div>
                <div class="carousel carousel-nav" id="date-carousel" data-flickity='{"contain": true, "pageDots": false }'>
                  <!-- Dates will be dynamically generated here -->
                </div>
                <ul class="time-ul" id="show-times-container">
                  <!-- Show times will be dynamically generated here -->
                </ul>
              </div>
              <input id="screen-next-btn" type="button" name="next-step" class="next-step" value="Continue Booking"
                disabled />
            </fieldset>
            <fieldset>

              <div>
                <iframe id="seat-sel-iframe"
                  style="  box-shadow: 0 14px 12px 0 var(--theme-border), 0 10px 50px 0 var(--theme-border); width: 800px; height: 550px; display: block; margin-left: auto; margin-right: auto;"
                  src="seat_selection/seat_sel.html"></iframe>
              </div>
              <br>
              <input type="button" name="next-step" class="next-step" value="Proceed to Payment" />
              <input type="button" name="previous-step" class="previous-step" value="Back" />
            </fieldset>
            <fieldset>
              <!-- Payment Page -->
              <div id="payment_div">
                <div class="payment-row">
                  <div class="col-75">
                    <div class="payment-container">
                      <div class="payment-row">
                        <div class="col-50">
                          <h3 id="payment-h3">Payment</h3>
                          <div class="payment-row payment">
                            <div class="col-50 payment">
                              <label for="card" class="method card">
                                <div class="icon-container">
                                  <i class="fa fa-cc-visa" style="color: navy"></i>
                                  <i class="fa fa-cc-amex" style="color: blue"></i>
                                  <i class="fa fa-cc-mastercard" style="color: red"></i>
                                  <i class="fa fa-cc-discover" style="color: orange"></i>
                                </div>
                                <div class="radio-input">
                                  <input type="radio" id="card" />
                                  Pay RS.200.00 with credit card
                                </div>
                              </label>
                            </div>
                            <div class="col-50 payment">
                              <label for="paypal" class="method paypal">
                                <div class="icon-container">
                                  <i class="fa fa-paypal" style="color: navy"></i>
                                </div>
                                <div class="radio-input">
                                  <input id="paypal" type="radio" checked>
                                  Pay $30.00 with PayPal
                                </div>
                              </label>
                            </div>
                          </div>

                          <div class="payment-row">
                            <div class="col-50">
                              <label for="cname">Cardholder's Name</label>
                              <input type="text" id="cname" name="cardname" placeholder="Firstname Lastname" required />
                            </div>
                            <div class="col-50">
                              <label for="ccnum">Credit card number</label>
                              <input type="text" id="ccnum" name="cardnumber" placeholder="xxxx-xxxx-xxxx-xxxx"
                                required />
                            </div>
                          </div>
                          <div class="payment-row">
                            <div class="col-50">
                              <label for="expmonth">Exp Month</label>
                              <input type="text" id="expmonth" name="expmonth" placeholder="September" required />
                            </div>
                            <div class="col-50">
                              <div class="payment-row">
                                <div class="col-50">
                                  <label for="expyear">Exp Year</label>
                                  <input type="text" id="expyear" name="expyear" placeholder="yyyy" required />
                                </div>
                                <div class="col-50">
                                  <label for="cvv">CVV</label>
                                  <input type="text" id="cvv" name="cvv" placeholder="xxx" required />
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <input type="button" name="next-step" class="next-step pay-btn" value="Confirm Payment" />
              <input type="button" name="previous-step" class="cancel-pay-btn" value="Cancel Payment"
                onclick="location.href='index.html';" />
            </fieldset>
            <fieldset>
              <h2>E-Ticket</h2>
              <div class="ticket-body">
                <div class="ticket">
                  <div class="holes-top"></div>
                  <div class="title">
                    <p class="cinema">MyShowz Entertainment</p>
                    <p class="movie-title">Movie Name</p>
                  </div>
                  <div class="poster">
                    <img src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/25240/only-god-forgives.jpg"
                      alt="Movie: Only God Forgives" />
                  </div>
                  <div class="info">
                    <table class="info-table ticket-table">
                      <tr>
                        <th>SCREEN</th>
                        <th>ROW</th>
                        <th>SEAT</th>
                      </tr>
                      <tr>
                        <td class="bigger">18</td>
                        <td class="bigger">H</td>
                        <td class="bigger">24</td>
                      </tr>
                    </table>
                    <table class="info-table ticket-table">
                      <tr>
                        <th>PRICE</th>
                        <th>DATE</th>
                        <th>TIME</th>
                      </tr>
                      <tr>
                        <td>RS.12.00</td>
                        <td>4/13/21</td>
                        <td>19:30</td>
                      </tr>
                    </table>
                  </div>
                  <div class="holes-lower"></div>
                  <div class="serial">
                    <table class="barcode ticket-table">
                      <tr>
                        <td style="background-color:black;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:white;"></td>
                        <td style="background-color:black;"></td>
                        <td style="background-color:white;"></td>
                      </tr>
                    </table>
                    <table class="numbers ticket-table">
                      <tr>
                        <td>9</td>
                        <td>1</td>
                        <td>7</td>
                        <td>3</td>
                        <td>7</td>
                        <td>5</td>
                        <td>4</td>
                        <td>4</td>
                        <td>4</td>
                        <td>5</td>
                        <td>4</td>
                        <td>1</td>
                        <td>4</td>
                        <td>7</td>
                        <td>8</td>
                        <td>7</td>
                        <td>3</td>
                        <td>4</td>
                        <td>1</td>
                        <td>4</td>
                        <td>5</td>
                        <td>2</td>
                      </tr>
                    </table>
                  </div>
                </div>
              </div>
              <input type="button" name="previous-step" class="home-page-btn" value="Browse to Home Page"
                onclick="location.href='index.html';" />
            </fieldset>
          </form>
        </div>
      </div>
    </div>
  </div>
</body>
<script>
  let prevId = null;
  let selectedDate = null;
  let selectedTime = null;
  let selectedScreen = null;

  // Show times configuration (24-hour format)
  const showTimesData = {
    'Screen 1': ['09:00', '13:05', '16:00', '21:00'],
    'Screen 2': ['10:30', '15:00', '19:30'],
    'Screen 3': ['09:05', '12:00', '17:00', '22:00'],
    'Screen 4': ['09:05', '11:00', '15:00', '19:00', '22:00', '23:00'],
    'Screen 5': ['09:05', '12:00', '13:00', '15:00', '18:30']
  };

  window.onload = function () {
    document.getElementById("screen-next-btn").disabled = true;
    initializeDateSelection();
    updateCurrentDateTime();
    // Update current time every minute
    setInterval(updateCurrentDateTime, 60000);
  }

  function updateCurrentDateTime() {
    const now = new Date();
    const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    const timeOptions = { hour: '2-digit', minute: '2-digit', hour12: true };
    
    document.getElementById('current-date-display').textContent = 
      'Today: ' + now.toLocaleDateString('en-US', dateOptions);
    document.getElementById('current-time-display').textContent = 
      ' | Current Time: ' + now.toLocaleTimeString('en-US', timeOptions);
  }

  function initializeDateSelection() {
    const carousel = document.getElementById('date-carousel');
    const today = new Date();
    
    // Generate next 7 days
    for (let i = 0; i < 7; i++) {
      const date = new Date(today);
      date.setDate(today.getDate() + i);
      
      const dayNum = date.getDate();
      const dayName = i === 0 ? 'Today' : i === 1 ? 'Tomorrow' : 
                      date.toLocaleDateString('en-US', { weekday: 'long' });
      const fullDate = date.toISOString().split('T')[0];
      
      const cell = document.createElement('div');
      cell.className = 'carousel-cell';
      cell.id = 'date-' + i;
      cell.setAttribute('data-date', fullDate);
      cell.onclick = function() { selectDate(i, fullDate); };
      
      cell.innerHTML = `
        <div class="date-numeric">${dayNum}</div>
        <div class="date-day">${dayName}</div>
      `;
      
      carousel.appendChild(cell);
    }
    
    // Initialize Flickity after adding cells
    setTimeout(() => {
      const flkty = new Flickity(carousel, {
        contain: true,
        pageDots: false
      });
    }, 100);
  }

  function selectDate(id, dateString) {
    // Remove previous selection
    if (prevId !== null) {
      document.getElementById('date-' + prevId).style.background = "rgb(243, 235, 235)";
    }
    
    // Set new selection
    document.getElementById('date-' + id).style.background = "#df0e62";
    prevId = id;
    selectedDate = dateString;
    
    // Generate show times for selected date
    generateShowTimes(dateString);
  }

  function generateShowTimes(dateString) {
    const container = document.getElementById('show-times-container');
    container.innerHTML = '';
    
    const selectedDateTime = new Date(dateString);
    const now = new Date();
    const isToday = dateString === now.toISOString().split('T')[0];
    const currentHour = now.getHours();
    const currentMinute = now.getMinutes();
    
    // Generate show times for each screen
    Object.keys(showTimesData).forEach(screen => {
      const li = document.createElement('li');
      li.className = 'time-li';
      
      const screenDiv = document.createElement('div');
      screenDiv.className = 'screens';
      screenDiv.textContent = screen;
      
      const timeBtnDiv = document.createElement('div');
      timeBtnDiv.className = 'time-btn';
      
      // Add time buttons
      showTimesData[screen].forEach(time => {
        const [hour, minute] = time.split(':').map(Number);
        
        // Check if show time has passed (only for today)
        let isPast = false;
        if (isToday) {
          if (hour < currentHour || (hour === currentHour && minute <= currentMinute)) {
            isPast = true;
          }
        }
        
        const button = document.createElement('button');
        button.className = 'screen-time';
        button.textContent = formatTime(time);
        button.setAttribute('data-time', time);
        button.setAttribute('data-screen', screen);
        
        if (isPast) {
          button.disabled = true;
          button.classList.add('past-time');
          button.title = 'Show time has passed';
        } else {
          button.onclick = function() { selectShowTime(this, screen, time); };
        }
        
        timeBtnDiv.appendChild(button);
      });
      
      li.appendChild(screenDiv);
      li.appendChild(timeBtnDiv);
      container.appendChild(li);
    });
  }

  function formatTime(time24) {
    const [hour, minute] = time24.split(':').map(Number);
    const period = hour >= 12 ? 'PM' : 'AM';
    const hour12 = hour % 12 || 12;
    return `${hour12}:${minute.toString().padStart(2, '0')} ${period}`;
  }

  function selectShowTime(button, screen, time) {
    // Remove previous time selection
    document.querySelectorAll('.screen-time').forEach(btn => {
      btn.classList.remove('selected-time');
    });
    
    // Set new selection
    button.classList.add('selected-time');
    selectedTime = time;
    selectedScreen = screen;
    
    // Enable continue button
    document.getElementById("screen-next-btn").disabled = false;
    
    // Store booking details
    sessionStorage.setItem('bookingDate', selectedDate);
    sessionStorage.setItem('bookingTime', time);
    sessionStorage.setItem('bookingScreen', screen);
    
    console.log('Selected:', { date: selectedDate, time: time, screen: screen });
  }

  // Keep old function name for compatibility
  function timeFunction() {
    document.getElementById("screen-next-btn").disabled = false;
  }

  function myFunction(id) {
    selectDate(id, selectedDate);
  }
</script>

<script src="https://npmcdn.com/flickity@2/dist/flickity.pkgd.js"></script>
<script type="text/javascript" src='https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.bundle.min.js'>
</script>
<script type="text/javascript" src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js'></script>
<script src="assets/js/theme-change.js"></script>
<script src="assets/js/booking-manager.js"></script>

<script type="text/javascript" src="assets/js/ticket-booking.js"></script>

<script>
  // Handle payment confirmation and create booking
  document.addEventListener('DOMContentLoaded', function() {
    const paymentBtn = document.querySelector('.pay-btn');
    
    if (paymentBtn) {
      paymentBtn.addEventListener('click', function() {
        // Get booking details from session storage
        const bookingDate = sessionStorage.getItem('bookingDate');
        const bookingTime = sessionStorage.getItem('bookingTime');
        const bookingScreen = sessionStorage.getItem('bookingScreen');
        
        // Get payment details
        const cardholderName = document.getElementById('cname')?.value || 'Guest User';
        const paymentMethod = document.querySelector('input[name="payment"]:checked')?.nextSibling?.textContent || 'Card';
        
        // Create booking if we have the required data
        if (bookingDate && bookingTime && bookingScreen && window.bookingManager) {
          const booking = window.bookingManager.createBooking({
            userName: cardholderName,
            userEmail: cardholderName.toLowerCase().replace(' ', '.') + '@example.com',
            movieName: 'Selected Movie', // You can get this from URL params or session
            screen: bookingScreen,
            date: bookingDate,
            time: bookingTime,
            seats: ['A1', 'A2'], // Get from seat selection
            seatCount: 2, // Get from seat selection
            amount: 400, // Calculate based on seats
            paymentMethod: paymentMethod.includes('PayPal') ? 'PayPal' : 'Card',
            status: 'Confirmed'
          });
          
          console.log('Booking created successfully:', booking);
          
          // Store booking ID for e-ticket display
          sessionStorage.setItem('currentBookingId', booking.id);
          
          // Update e-ticket with booking details
          updateETicket(booking);
        }
      });
    }
  });
  
  // Update e-ticket display with booking details
  function updateETicket(booking) {
    // Update movie title
    const movieTitle = document.querySelector('.movie-title');
    if (movieTitle) movieTitle.textContent = booking.movieName;
    
    // Update screen
    const screenCell = document.querySelector('.info-table td.bigger');
    if (screenCell) screenCell.textContent = booking.screen.replace('Screen ', '');
    
    // Update date
    const dateCell = document.querySelectorAll('.info-table td')[7];
    if (dateCell) dateCell.textContent = new Date(booking.date).toLocaleDateString();
    
    // Update time
    const timeCell = document.querySelectorAll('.info-table td')[8];
    if (timeCell) {
      const [hour, minute] = booking.time.split(':').map(Number);
      const period = hour >= 12 ? 'PM' : 'AM';
      const hour12 = hour % 12 || 12;
      timeCell.textContent = `${hour12}:${minute.toString().padStart(2, '0')} ${period}`;
    }
    
    // Update price
    const priceCell = document.querySelectorAll('.info-table td')[6];
    if (priceCell) priceCell.textContent = `â‚¹${booking.amount}.00`;
  }
</script>

</html>